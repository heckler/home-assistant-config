homeassistant:
  # Name of the location where Home Assistant is running
  name: Home
  # Location required to calculate the time the sun rises and sets
  latitude: !secret home_latitude
  longitude: !secret home_longitude
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: !secret home_elevation
  # metric for Metric, imperial for Imperial
  unit_system: metric
  # Pick yours from here: http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
  time_zone: America/Sao_Paulo
  # Customization file
  customize: !include customize.yaml

# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:


# load themes from a subfolder containing configs:
frontend:
   #themes: !include_dir_merge_named themes/


# Show the introduction message on startup.
# introduction:

# Uncomment this if you are using SSL/TLS, running in Docker container, etc.
# http:
#   base_url: example.duckdns.org:8123


# ----------------------------------------------------------------------------------
# Recorder configuration - limit which entities have history preserved
# ----------------------------------------------------------------------------------
recorder:
  auto_purge: true
  purge_keep_days: 14
  commit_interval: 30
  include:
    entities:
      - sensor.balcony_humidity
      - sensor.balcony_temperature
      - sensor.emoncms_home_power
      - sensor.emoncms_home_power_kwh
      - sensor.emoncms_node_emontx3_a_powera
      - sensor.emoncms_node_emontx3_a_powera_kwh
      - sensor.emoncms_node_emontx3_a_vrms
      - sensor.emoncms_node_emontx3_b_powerb
      - sensor.emoncms_node_emontx3_b_powerb_kwh
      - sensor.emoncms_node_emontx3_b_vrms
      - sensor.emoncms_node_emontx3_c_powerc
      - sensor.emoncms_node_emontx3_c_powerc_kwh
      - sensor.emoncms_node_emontx3_c_vrms
      - sensor.freezer_internal_temperature
      - sensor.freezer_external_temperature
      - sensor.fridge_main_temperature
      - sensor.fridge_freezer_temperature
      - sensor.memory_use_percent
      - light.wakeup_light_01r
      - light.wakeup_light_02g
      - switch.irrigation_pump_relay
      - switch.fireplace_light_relay
      - sensor.problem_check


# ----------------------------------------------------------------------------------
# InfluxDB configuration
# ----------------------------------------------------------------------------------
influxdb:
  host: a0d7b954-influxdb
  port: 8086
  database: homeassistant
  username: homeassistant
  password: !secret influxdb_password
  max_retries: 3
  default_measurement: state
  include:
    entities:
      - sensor.balcony_humidity
      - sensor.balcony_temperature
      - sensor.emoncms_home_power
      - sensor.emoncms_home_power_kwh
      - sensor.emoncms_node_emontx3_a_powera
      - sensor.emoncms_node_emontx3_a_powera_kwh
      - sensor.emoncms_node_emontx3_a_vrms
      - sensor.emoncms_node_emontx3_b_powerb
      - sensor.emoncms_node_emontx3_b_powerb_kwh
      - sensor.emoncms_node_emontx3_b_vrms
      - sensor.emoncms_node_emontx3_c_powerc
      - sensor.emoncms_node_emontx3_c_powerc_kwh
      - sensor.emoncms_node_emontx3_c_vrms
      - sensor.balcony_02_pressure
      - sensor.freezer_internal_temperature
      - sensor.freezer_external_temperature
      - sensor.fridge_main_temperature
      - sensor.fridge_freezer_temperature
  component_config_glob:
    sensor.*humidity:
      override_measurement: humidity
    sensor.*temperature:
      override_measurement: temperature
    sensor.*pressure:
      override_measurement: pressure



# weather platforms
weather:
  - platform: darksky
    name: weather-1
    api_key: !secret darksky_api_key
  


# Transmission integration
#transmission:
#  host: !secret transmission_host
#  port: !secret transmission_port
#  username: !secret transmission_user
#  password: !secret transmission_passord


# ----------------------------------------------------------------------------------
# Sensors
# ----------------------------------------------------------------------------------
sensor:

  # System monitor: CPU, Memory and disk:
  - platform: systemmonitor
    resources:
      - type: disk_use_percent
        arg: /
      - type: memory_use_percent
      - type: load_1m
      - type: swap_free
      - type: last_boot


  # CPU temperature, using commmand_line sensor:
  - platform: command_line
    name: CPU Temperature
    command: "cat /sys/class/thermal/thermal_zone0/temp"
    unit_of_measurement: "Â°C"
    value_template: '{{ value | multiply(0.001) | round(1) }}'


  # ----------------------------------------------------------------------------------
  # EmonCMS sensor patform, CAH 2019-10-25
  # info:  https://www.home-assistant.io/integrations/emoncms
  # feeds: http://emonpi/emoncms/feed/list
  # ----------------------------------------------------------------------------------
  # faster update for the instant power and current feeds
  - platform: emoncms
    api_key: !secret emoncms_api_key
    url: !secret emoncms_url
    id: 1
    scan_interval: 10
    include_only_feed_id:
      - 2
      - 5
      - 3
      - 8
      - 4
      - 10
      - 17
  # slower update rate for the accumulated power feeds
  - platform: emoncms
    api_key: !secret emoncms_api_key
    url: !secret emoncms_url
    id: 1
    scan_interval: 60
    include_only_feed_id:
      - 6
      - 9
      - 11
      - 18


  # Date/Time sensor is used to allow automation templates which get triggered (re-evaluated) every minute
  - platform: time_date
    display_options:
    - "date_time_utc"
    - "date_time_iso"
    - "date"


# availability-base indication of problems with the sensors
  - platform: template
    sensors:
      problem_check:
        value_template: >-
          {% if ((as_timestamp(now()) - as_timestamp(states('sensor.uptime'))) > 60) %}
          {{ 
             is_state('sensor.balcony_uptime', 'unavailable') or 
             is_state('sensor.balcony_02_uptime', 'unavailable') or 
             is_state('sensor.fireplace_light_uptime', 'unavailable') or 
             is_state('sensor.emoncms_node_emontx3_a_powera', 'unavailable') or 
             is_state('sensor.emoncms_node_emontx3_b_powerb', 'unavailable') or 
             is_state('sensor.emoncms_node_emontx3_c_powerc', 'unavailable') or 
             ( (now() - states.sensor.balcony_uptime.last_updated).total_seconds() > 600) or
             ( (now() - states.sensor.balcony_02_uptime.last_updated).total_seconds() > 600) or
             ( (now() - states.sensor.fireplace_light_uptime).total_seconds() > 600) or
             ( (now() - states.sensor.emoncms_node_emontx3_a_powera.last_updated).total_seconds() > 600) or
             ( (now() - states.sensor.emoncms_node_emontx3_b_powerb.last_updated).total_seconds() > 600) or
             ( (now() - states.sensor.emoncms_node_emontx3_c_powerc.last_updated).total_seconds() > 600)
          }}
          {% endif %}
      problem_status:
        value_template: >-
          {% if states.sensor.problem_check %}
             {% if states.sensor.problem_check.state == "True" %}
                Problem
             {% else %}
                Ok
             {% endif %}
          {% else %}
            N/A
          {% endif %}
        attribute_templates:
          Balcony_01: '{% if is_state("sensor.balcony_uptime", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.balcony_uptime.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}' 
          Balcony_02: '{% if is_state("sensor.balcony_02_uptime", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.balcony_02_uptime.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}'
          Fireplace_light: '{% if is_state("sensor.fireplace_light_uptime", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.fireplace_light_uptime.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}'
          Emoncms_power_A: '{% if is_state("sensor.emoncms_node_emontx3_a_powera", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.emoncms_node_emontx3_a_powera.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}'
          Emoncms_power_B: '{% if is_state("sensor.emoncms_node_emontx3_b_powerb", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.emoncms_node_emontx3_b_powerb.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}'
          Emoncms_power_C: '{% if is_state("sensor.emoncms_node_emontx3_c_powerc", "unavailable") %} Unavailable {% else %} {% if ( (now() - states.sensor.emoncms_node_emontx3_c_powerc.last_updated).total_seconds() > 600) %} Stale {% else %} OK {% endif %} {% endif %}'
        friendly_name: Status


  # determine if Rafael's wake-up light should run today:
  - platform: template
    sensors:
      rafael_wakeup_should_run:
        value_template:  >
          {% set sensor_names = [ 'monday', 'tuesday', 'wednesday','thursday','friday','saturday','sunday'] %}
          {% set today_name = sensor_names[now().weekday()] %}
          {% set entity_id = 'input_boolean.rafael_wakeup_'+today_name %}
          {{ is_state('input_boolean.rafael_wakeup_enabled', 'on') and is_state(entity_id, 'on') }}

  # determine if Gabriela's wake-up light should run today:
  - platform: template
    sensors:
      gabriela_wakeup_should_run:
        value_template:  >
          {% set sensor_names = [ 'monday', 'tuesday', 'wednesday','thursday','friday','saturday','sunday'] %}
          {% set today_name = sensor_names[now().weekday()] %}
          {% set entity_id = 'input_boolean.gabriela_wakeup_'+today_name %}
          {{ is_state('input_boolean.gabriela_wakeup_enabled', 'on') and is_state(entity_id, 'on') }}




# Text to speech
tts:
  - platform: google_translate
    service_name: google_say


# ----------------------------------------------------------------------------------
# Telegram bot configuration
# ----------------------------------------------------------------------------------
telegram_bot:
  - platform: polling
    api_key: !secret telegram_api_key
    allowed_chat_ids:
      - !secret telegram_chat_id_1



# ----------------------------------------------------------------------------------
# Notification settings
# ----------------------------------------------------------------------------------
notify:

  - platform: telegram
    name: telegram
    chat_id: !secret telegram_chat_id_1


# ----------------------------------------------------------------------------------
# iFrame panel: extra links
# info: https://www.home-assistant.io/integrations/panel_iframe/
# ----------------------------------------------------------------------------------
panel_iframe:
  emon_cms:
    title: 'EmonCMS'
    url: 'http://emonpi.local/emoncms/dashboard/view/cah'


# load manually created automations from a subfolder:
# GUI- and blueprint- created automations are stored in confg/automations.yaml
# and a symlink under the automations folder allows it to be included:
# cd /root/config/automations
# ln -s ../automations.yaml gui_automations.yaml
automation: !include_dir_merge_list automations/


group: !include groups.yaml
script: !include scripts.yaml
scene: !include scenes.yaml


# ----------------------------------------------------------------------------------
# (experiment) Telegram alarm for high freezer temperature
# ----------------------------------------------------------------------------------

binary_sensor:
  - platform: template
    sensors:
      freezer_is_warm:
        friendly_name: "Freezer temperature too high"
        value_template: >-
           {% if ((as_timestamp(now()) - as_timestamp(states('sensor.uptime'))) > 60) %}
           {{ float(states.sensor.freezer_internal_temperature.state) > -10.0 }}
           {% endif %}

alert:
  freezer_is_warm:
    name: "Freezer temperature too high"
    entity_id: binary_sensor.freezer_is_warm
    repeat: 30
    skip_first: true
    notifiers:
      - telegram
    data:
      message: Freezer temperature too high




# ----------------------------------------------------------------------------------
# helper inputs for the two wake-up alarm lights
# ----------------------------------------------------------------------------------

# input_booleans to on/off days for the wake-up lights
input_boolean: 
  rafael_wakeup_enabled:
  rafael_wakeup_monday:
  rafael_wakeup_tuesday:
  rafael_wakeup_wednesday:
  rafael_wakeup_thursday:
  rafael_wakeup_friday:
  rafael_wakeup_saturday:
  rafael_wakeup_sunday:
  gabriela_wakeup_enabled:
  gabriela_wakeup_monday:
  gabriela_wakeup_tuesday:
  gabriela_wakeup_wednesday:
  gabriela_wakeup_thursday:
  gabriela_wakeup_friday:
  gabriela_wakeup_saturday:
  gabriela_wakeup_sunday:

# time of the wake-up alarms
input_datetime:
  rafael_wakeup_alarm_time:
    name: Rafael Wake-up time
    has_date: false
    has_time: true
  gabriela_wakeup_alarm_time:
    name: Gabriela Wake-up time
    has_date: false
    has_time: true


